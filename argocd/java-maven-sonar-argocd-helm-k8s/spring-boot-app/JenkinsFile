stage('Update Deployment File') {
  environment {
    GIT_REPO_NAME = "Ultimate_CI-CD_pipeline"
    GIT_user = "ajaykumart797"
  }
  steps {
    withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
      dir('argocd/java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests') {
        sh '''
          echo "Current directory: $(pwd)"
          ls -la
          # Check if .git directory exists
          if [ -d ".git" ]; then
            echo ".git directory exists"
          else
            echo ".git directory does not exist, initializing Git repository"
            git init
          fi
          # Verify .git directory exists after initialization
          if [ -d ".git" ]; then
            echo ".git directory exists after initialization"
          else
            echo "Failed to initialize .git directory"
            exit 1
          fi
          echo "Configuring Git user email and name"
          git config --global user.email "ajaykumart797@gmail.com"
          git config --global user.name "ajaykumart797"
          echo "Git user email and name configured"
          git config --global --add safe.directory /var/lib/jenkins/workspace/Argocd_pipeline/argocd/java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests
          BUILD_NUMBER=${BUILD_NUMBER}
          sed -i "s/replaceImageTag/${BUILD_NUMBER}/g" deployment.yml
          git add deployment.yml
          git commit --only deployment.yml -m "Update deployment image to version ${BUILD_NUMBER}"
          git pull https://${GITHUB_TOKEN}@github.com/${GIT_user}/${GIT_REPO_NAME} main --rebase
          git push https://${GITHUB_TOKEN}@github.com/${GIT_user}/${GIT_REPO_NAME} HEAD:main
        '''
      }
    }
  }
}
